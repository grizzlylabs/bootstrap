#!/bin/bash
############## seed.manifests
#
clear
printf "\n"
printf "This script creates the puppet manifest files\n"
printf "             1. to manage this deployment box\n"
printf "             2. To rebuild this box or create another\n"
printf "             3. To provide a framework for your entire deployment\n" 
printf "\n"
printf "\n"

read -p "### Press [Enter] key to continue ###"
clear

#
#############
#
# Get any variables
#
# Inspect bootstrap.cfg before you execute this script
#
source ./bootstrap.cfg
#
#############
#
printf "\n" 
printf "copy (if exist) or create site.pp\n"
printf "\n" 

if [ -e ""$LOCAL_FOLDER"/puppet/manifests/site.pp" ]
then
   printf "File exists but not in puppet. Copying to puppet\n"
   printf "\n"
   cp $LOCAL_FOLDER/puppet/manifests/site.pp "$MANIFEST_DIR"
else
   printf "File does not exist. Creating and installing file\n"
   printf "\n"
   printf "import \'nodes.pp\'\n" > $LOCAL_FOLDER/puppet/manifests/site.pp
   cp $LOCAL_FOLDER/puppet/manifests/site.pp "$MANIFEST_DIR"
fi

printf "\n"
read -p "### Press [Enter] key to continue ###"
clear

#############
#

printf "\n" 
printf "Manage nodes.pp\n"
printf "\n" 

if [ -e ""$LOCAL_FOLDER"/puppet/manifests/nodes.pp" ]
then
   printf "File exists but not in puppet. Copying to puppet\n"
   printf "\n"
   cp $LOCAL_FOLDER/puppet/manifests/nodes.pp $PUPPET_FOLDER/manifests/nodes.pp
else
   printf "File does not exist. Creating and installing file\n"
   printf "\n"
   printf "node \'$MY_FQDN'\' {\n"  > "$LOCAL_FOLDER"/puppet/manifests/nodes.pp
  printf "   class { \'::ntp\' :\n" >> "$LOCAL_FOLDER"/puppet/manifests/nodes.pp
  printf "   servers => [\'0.pool.ntp.org\', \'1.pool.ntp.org\' ] ,\n" >> "$LOCAL_FOLDER"/puppet/manifests/nodes.pp
   printf "}\n" >> "$LOCAL_FOLDER"/puppet/manifests/nodes.pp

   cp $LOCAL_FOLDER/puppet/manifests/nodes.pp $PUPPET_FOLDER/manifests/nodes.pp
fi

printf "\n"
read -p "### Press [Enter] key to continue ###"
clear

#############
#

printf "\n" 
printf "install public modeles\n"
printf "\n" 

#uninstall chrony and replace it with ntp
sudo systemctl stop chronyd
sudo yum remove chrony
sudo puppet module install --target-dir "$PUPPET_FOLDER"/modules puppetlabs-ntp


printf "\n"
read -p "### Press [Enter] key to continue ###"
clear

#############
#

printf "\n" 
printf "apply puppet to this system\n"
printf "look for errors!\n"
printf "\n" 

sudo puppet apply "$PUPPET_FOLDER"/manifests/site.pp --modulepath="$PUPPET_FOLDER"/modules 

printf "\n"
read -p "### Press [Enter] key to continue ###"
clear

############################ EOF ###############################
