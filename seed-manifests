#!/bin/bash
#############
#
# Get any variables
#
# Inspect bootstrap.cfg before you execute this script
#
source ./bootstrap.cfg
#
############## seed.manifests
#
clear
printf "\n"
printf "This script creates the puppet manifest files\n"
printf "             1. to manage this deployment box\n"
printf "             2. To rebuild this box or create another\n"
printf "             3. To provide a framework for your entire deployment\n" 
printf "\n"
printf "\n"

read -p "### Press [Enter] key to continue ###"
clear

#
#############
#
printf "\n"
printf "Modify Puppet config file\n"
printf "\n"
printf "Set the environmentpath\n"
printf "\n"

# puppet wants the following line in puppet.conf
# environmentpath = $confdir/environments
# It should be in [main]

# We will add three lines from bottom to top
#
# #Puppets Environment Path
# environmentpath = $confdir/environments
# {a blank line}

if  ! grep -q 'environmentpath' "$PUPPET_ROOT"/puppet.conf"" 
then
   printf "Modifing puppet.conf\n"
   printf "\n"
   sudo sed -i 's/\[main\]/&\n /' "$PUPPET_ROOT"/puppet.conf
   sudo sed -i 's/\[main\]/&\n    environmentpath = $confdir\/environments/' "$PUPPET_ROOT"/puppet.conf
   sudo sed -i 's/\[main\]/&\n    \# Puppet Environment Path /' "$PUPPET_ROOT"/puppet.conf
   sudo sed -i 's/\[main\]/&\n /' "$PUPPET_ROOT"/puppet.conf
fi

printf "\n"
read -p "### Press [Enter] key to continue ###"
clear

#############
#

# manage hiera here
printf "\n" 
printf "Configuring hiera\n"
printf "\n" 

sudo mkdir -p             "$PUPPET_ROOT"/hieradata
sudo chown -R root:puppet "$PUPPET_ROOT"/hieradata
sudo chmod -R 770         "$PUPPET_ROOT"/hieradata
sudo chmod -R g+s         "$PUPPET_ROOT"/hieradata

#if [ ! -e ""$PUPPET_ROOT"/" ]
#then
#   printf "File exists but not in puppet. Copying to puppet\n"
#   printf "\n"
#   cp $LOCAL_FOLDER/puppet/manifests/site.pp "$MANIFEST_DIR"
#else
#   printf "File does not exist. Creating and installing file\n"
#   printf "\n"
#   printf "import \'nodes.pp\'\n" > $LOCAL_FOLDER/puppet/manifests/site.pp
#   cp $LOCAL_FOLDER/puppet/manifests/site.pp "$MANIFEST_DIR"
#fi

#printf "\n"
#read -p "### Press [Enter] key to continue ###"
#clear

#############
#

printf "\n" 
printf "Manage node manifest for this server\n"
printf "\n" 

HOSTpp=""$MANIFEST_DIR"/`hostname`.pp"

if [ -e "$HOSTpp" ]
then
   printf "File exists \n"
   printf "\n"
else
  printf "File does not exist. Creating and installing file\n"
  printf "\n"
  printf "Creating File: "$HOSTpp"\n"
  printf "\n"
  printf "node \'$MY_FQDN\' {\n"     > "$HOSTpp"
  printf "   class { \'::ntp\' :\n" >> "$HOSTpp"
printf " servers => [\'0.pool.ntp.org\', \'1.pool.ntp.org\' ] ,\n" >> "$HOSTpp"
  printf "   }\n"                   >> "$HOSTpp"
  printf "}\n"                      >> "$HOSTpp"
fi

printf "\n"
read -p "### Press [Enter] key to continue ###"
clear

#############
#

printf "\n" 
printf "install public modeles\n"
printf "\n" 

#uninstall chrony and replace it with ntp
sudo systemctl stop chronyd
sudo yum remove chrony
sudo puppet module install --target-dir "$PUPPET_FOLDER"/modules puppetlabs-ntp


printf "\n"
read -p "### Press [Enter] key to continue ###"
clear

#############
#

printf "\n" 
printf "apply puppet to this system\n"
printf "look for errors!\n"
printf "\n" 

if [ ! -e "$LOCAL_FOLDER"/papply ]
then

   #$PUPPET_APPLY="$MANIFEST_DIR/site.pp --modulepath=$MODULE_DIR $*"
   printf "#\!/bin/bash\n"         >  "$LOCAL_FOLDER"/papply
   printf "\n"                     >> "$LOCAL_FOLDER"/papply
   printf "puppet apply "          >> "$LOCAL_FOLDER"/papply
   printf "$MANIFEST_DIR/site.pp"  >> "$LOCAL_FOLDER"/papply
   printf ' --modulepath='         >> "$LOCAL_FOLDER"/papply
   printf "$MODULE_DIR"            >> "$LOCAL_FOLDER"/papply
   printf ' $*'                    >> "$LOCAL_FOLDER"/papply
   printf "\n"                     >> "$LOCAL_FOLDER"/papply
fi

if [ ! -e $PUPPET_APPLY_DIR/papply ]
then
   sudo cp "$LOCAL_FOLDER/papply" "$PUPPET_APPLY_DIR"
   sudo chown root:puppet "$PUPPET_APPLY_DIR/papply"
   sudo chmod 770 "$PUPPET_APPLY_DIR/papply"
fi

#sudo puppet apply "$PUPPET_FOLDER"/manifests/site.pp --modulepath="$PUPPET_FOLDER"/modules 

printf "\n"
read -p "### Press [Enter] key to continue ###"
clear

############################ EOF ###############################
